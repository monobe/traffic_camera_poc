<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Traffic Monitoring</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: #333;
        }

        .back-button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .back-button:hover {
            background: #0056b3;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .settings-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .settings-card h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #999;
            font-size: 12px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .calibration-section {
            grid-column: 1 / -1;
        }

        #calibration-canvas {
            width: 100%;
            max-width: 960px;
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: crosshair;
            display: block;
            margin: 20px auto;
        }

        .calibration-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }

        .calibration-info p {
            margin: 5px 0;
            color: #555;
        }

        .status-message {
            padding: 10px 15px;
            border-radius: 4px;
            margin-top: 15px;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h1>
            <a href="/" class="back-button">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a>
        </header>

        <div class="settings-grid">
            <!-- Calibration Section -->
            <div class="settings-card calibration-section">
                <h2>ğŸ“ ã‚«ãƒ¡ãƒ©ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
                <p>é€Ÿåº¦æ¸¬å®šã®ç²¾åº¦å‘ä¸Šã®ãŸã‚ã€ã‚«ãƒ¡ãƒ©ã®ãƒ”ã‚¯ã‚»ãƒ«-ãƒ¡ãƒ¼ãƒˆãƒ«å¤‰æ›ä¿‚æ•°ã‚’è¨­å®šã—ã¾ã™ã€‚</p>

                <div style="margin: 20px 0;">
                    <button onclick="captureCalibrationFrame()" class="btn-primary">ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”»åƒã‚’å–å¾—</button>
                    <button onclick="resetCalibration()" class="btn-danger" style="margin-left: 10px;">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>

                <canvas id="calibration-canvas" style="display: none;"></canvas>

                <div id="calibration-instructions" class="calibration-info" style="display: none;">
                    <p><strong>æ‰‹é †:</strong></p>
                    <ol>
                        <li>ç”»åƒä¸Šã®2ç‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠï¼ˆé“è·¯ä¸Šã®æ—¢çŸ¥ã®è·é›¢ï¼‰</li>
                        <li>å®Ÿéš›ã®è·é›¢ã‚’ãƒ¡ãƒ¼ãƒˆãƒ«ã§å…¥åŠ›</li>
                        <li>ã€Œä¿å­˜ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                    </ol>
                </div>

                <div id="calibration-points-info" class="calibration-info" style="display: none;">
                    <p><strong>é¸æŠæ¸ˆã¿ãƒã‚¤ãƒ³ãƒˆ:</strong></p>
                    <p id="point1-info">Point 1: æœªé¸æŠ</p>
                    <p id="point2-info">Point 2: æœªé¸æŠ</p>
                    <p id="pixel-distance-info">ãƒ”ã‚¯ã‚»ãƒ«è·é›¢: -</p>
                </div>

                <div id="calibration-distance-input" style="display: none; margin-top: 20px;">
                    <div class="form-group">
                        <label>å®Ÿéš›ã®è·é›¢ (ãƒ¡ãƒ¼ãƒˆãƒ«):</label>
                        <input type="number" id="real-distance" step="0.1" min="0.1" placeholder="ä¾‹: 10.5">
                        <small>Google Mapsè¡›æ˜Ÿå†™çœŸã§2ç‚¹é–“ã®è·é›¢ã‚’æ¸¬å®šã—ã¦ãã ã•ã„</small>
                    </div>
                    <button onclick="saveCalibration()" class="btn-success">ä¿å­˜</button>
                </div>

                <div id="calibration-status" class="status-message"></div>
            </div>

            <!-- Speed Settings -->
            <div class="settings-card">
                <h2>ğŸš— é€Ÿåº¦æ¸¬å®šè¨­å®š</h2>
                <form id="speed-settings-form">
                    <div class="form-group">
                        <label>åˆ¶é™é€Ÿåº¦ (km/h):</label>
                        <input type="number" id="speed-limit" value="30" min="10" max="100">
                        <small>ã“ã®é€Ÿåº¦ã‚’è¶…ãˆã‚‹è»Šä¸¡ã‚’é€Ÿåº¦è¶…éã¨ã—ã¦è¨˜éŒ²ã—ã¾ã™</small>
                    </div>

                    <div class="form-group">
                        <label>æœ€å°ãƒˆãƒ©ãƒƒã‚¯é•·:</label>
                        <input type="number" id="min-track-length" value="10" min="5" max="30">
                        <small>é€Ÿåº¦è¨ˆç®—ã«å¿…è¦ãªæœ€å°ãƒ•ãƒ¬ãƒ¼ãƒ æ•°</small>
                    </div>

                    <div class="form-group">
                        <label>æ–¹å‘åˆ¤å®šé–¾å€¤ (ãƒ”ã‚¯ã‚»ãƒ«):</label>
                        <input type="number" id="direction-threshold" value="50" min="10" max="200">
                        <small>ä¸Šã‚Š/ä¸‹ã‚Šã‚’åˆ¤å®šã™ã‚‹ãŸã‚ã®å‚ç›´ç§»å‹•é‡</small>
                    </div>

                    <button type="submit" class="btn-primary">è¨­å®šã‚’ä¿å­˜</button>
                </form>
                <div id="speed-settings-status" class="status-message"></div>
            </div>

            <!-- Camera Settings -->
            <div class="settings-card">
                <h2>ğŸ“¹ ã‚«ãƒ¡ãƒ©è¨­å®š</h2>
                <form id="camera-settings-form">
                    <div class="form-group">
                        <label>FPS (ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ):</label>
                        <input type="number" id="camera-fps" value="15" min="5" max="30">
                        <small>1ç§’ã‚ãŸã‚Šã®å‡¦ç†ãƒ•ãƒ¬ãƒ¼ãƒ æ•°</small>
                    </div>

                    <div class="form-group">
                        <label>æ¤œå‡ºä¿¡é ¼åº¦:</label>
                        <input type="number" id="detection-confidence" value="0.5" step="0.05" min="0.1" max="0.95">
                        <small>ç‰©ä½“æ¤œå‡ºã®ä¿¡é ¼åº¦é–¾å€¤ï¼ˆ0.0-1.0ï¼‰</small>
                    </div>

                    <div class="form-group">
                        <label>è©³ç´°åˆ†é¡:</label>
                        <select id="enable-classification">
                            <option value="true">æœ‰åŠ¹</option>
                            <option value="false">ç„¡åŠ¹</option>
                        </select>
                        <small>è»Šç¨®è©³ç´°åˆ†é¡ï¼ˆã‚¿ã‚¯ã‚·ãƒ¼ã€è»½è‡ªå‹•è»Šãªã©ï¼‰</small>
                    </div>

                    <button type="submit" class="btn-primary">è¨­å®šã‚’ä¿å­˜</button>
                </form>
                <div id="camera-settings-status" class="status-message"></div>
            </div>

            <!-- Data Settings -->
            <div class="settings-card">
                <h2>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ä¿å­˜è¨­å®š</h2>
                <form id="data-settings-form">
                    <div class="form-group">
                        <label>ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé–“ (æ—¥):</label>
                        <input type="number" id="retention-days" value="90" min="7" max="365">
                        <small>ã“ã®æ—¥æ•°ã‚ˆã‚Šå¤ã„ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã™</small>
                    </div>

                    <div class="form-group">
                        <label>CSVå‡ºåŠ›:</label>
                        <select id="csv-enabled">
                            <option value="true">æœ‰åŠ¹</option>
                            <option value="false">ç„¡åŠ¹</option>
                        </select>
                        <small>æ—¥åˆ¥CSVãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›</small>
                    </div>

                    <button type="submit" class="btn-primary">è¨­å®šã‚’ä¿å­˜</button>
                </form>
                <div id="data-settings-status" class="status-message"></div>
            </div>
        </div>
    </div>

    <script>
        let calibrationImage = null;
        let calibrationPoints = [];
        let canvas = null;
        let ctx = null;

        // Capture calibration frame
        async function captureCalibrationFrame() {
            try {
                const response = await fetch('/api/calibration/capture');
                const blob = await response.blob();

                const img = new Image();
                img.onload = function() {
                    calibrationImage = img;
                    canvas = document.getElementById('calibration-canvas');
                    ctx = canvas.getContext('2d');

                    canvas.width = img.width;
                    canvas.height = img.height;
                    canvas.style.display = 'block';

                    drawCalibrationImage();

                    document.getElementById('calibration-instructions').style.display = 'block';
                    showStatus('calibration', 'ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”»åƒã‚’å–å¾—ã—ã¾ã—ãŸã€‚2ç‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'info');
                };
                img.src = URL.createObjectURL(blob);

            } catch (error) {
                showStatus('calibration', 'ã‚¨ãƒ©ãƒ¼: ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”»åƒã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // Draw calibration image with points
        function drawCalibrationImage() {
            if (!calibrationImage || !ctx) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(calibrationImage, 0, 0);

            // Draw points
            calibrationPoints.forEach((point, index) => {
                ctx.fillStyle = '#00ff00';
                ctx.beginPath();
                ctx.arc(point.x, point.y, 8, 0, 2 * Math.PI);
                ctx.fill();

                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 16px Arial';
                ctx.fillText(`P${index + 1}`, point.x + 12, point.y - 12);
            });

            // Draw line between points
            if (calibrationPoints.length === 2) {
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(calibrationPoints[0].x, calibrationPoints[0].y);
                ctx.lineTo(calibrationPoints[1].x, calibrationPoints[1].y);
                ctx.stroke();

                // Calculate and display pixel distance
                const pixelDist = calculatePixelDistance();
                const midX = (calibrationPoints[0].x + calibrationPoints[1].x) / 2;
                const midY = (calibrationPoints[0].y + calibrationPoints[1].y) / 2;

                ctx.fillStyle = '#00ff00';
                ctx.font = 'bold 14px Arial';
                ctx.fillText(`${pixelDist.toFixed(1)} pixels`, midX, midY);
            }

            updateCalibrationInfo();
        }

        // Canvas click handler
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('calibration-canvas');
            canvas.addEventListener('click', function(e) {
                if (calibrationPoints.length >= 2) return;

                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;

                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;

                calibrationPoints.push({x, y});
                drawCalibrationImage();

                if (calibrationPoints.length === 2) {
                    document.getElementById('calibration-distance-input').style.display = 'block';
                }
            });
        });

        // Calculate pixel distance
        function calculatePixelDistance() {
            if (calibrationPoints.length !== 2) return 0;

            const dx = calibrationPoints[1].x - calibrationPoints[0].x;
            const dy = calibrationPoints[1].y - calibrationPoints[0].y;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // Update calibration info display
        function updateCalibrationInfo() {
            const infoDiv = document.getElementById('calibration-points-info');
            infoDiv.style.display = 'block';

            if (calibrationPoints.length >= 1) {
                document.getElementById('point1-info').textContent =
                    `Point 1: (${Math.round(calibrationPoints[0].x)}, ${Math.round(calibrationPoints[0].y)})`;
            }

            if (calibrationPoints.length >= 2) {
                document.getElementById('point2-info').textContent =
                    `Point 2: (${Math.round(calibrationPoints[1].x)}, ${Math.round(calibrationPoints[1].y)})`;
                document.getElementById('pixel-distance-info').textContent =
                    `ãƒ”ã‚¯ã‚»ãƒ«è·é›¢: ${calculatePixelDistance().toFixed(1)} pixels`;
            }
        }

        // Reset calibration
        function resetCalibration() {
            calibrationPoints = [];
            if (ctx && canvas) {
                drawCalibrationImage();
            }
            document.getElementById('calibration-distance-input').style.display = 'none';
            document.getElementById('real-distance').value = '';
            updateCalibrationInfo();
        }

        // Save calibration
        async function saveCalibration() {
            const realDistance = parseFloat(document.getElementById('real-distance').value);

            if (!realDistance || realDistance <= 0) {
                showStatus('calibration', 'ã‚¨ãƒ©ãƒ¼: æœ‰åŠ¹ãªè·é›¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (calibrationPoints.length !== 2) {
                showStatus('calibration', 'ã‚¨ãƒ©ãƒ¼: 2ç‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const pixelDistance = calculatePixelDistance();
            const pixelsPerMeter = pixelDistance / realDistance;

            const calibrationData = {
                point1: calibrationPoints[0],
                point2: calibrationPoints[1],
                real_distance_meters: realDistance,
                pixel_distance: pixelDistance,
                pixels_per_meter: pixelsPerMeter
            };

            try {
                const response = await fetch('/api/calibration/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(calibrationData)
                });

                if (response.ok) {
                    showStatus('calibration',
                        `ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¿å­˜å®Œäº†ï¼ (${pixelsPerMeter.toFixed(2)} pixels/meter)`,
                        'success');
                } else {
                    showStatus('calibration', 'ã‚¨ãƒ©ãƒ¼: ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                showStatus('calibration', 'ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // Show status message
        function showStatus(section, message, type) {
            const statusDiv = document.getElementById(`${section}-status`);
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';

            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Form submit handlers
        document.getElementById('speed-settings-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            // TODO: Implement save
            showStatus('speed-settings', 'è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        });

        document.getElementById('camera-settings-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            // TODO: Implement save
            showStatus('camera-settings', 'è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        });

        document.getElementById('data-settings-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            // TODO: Implement save
            showStatus('data-settings', 'è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        });
    </script>
</body>
</html>
