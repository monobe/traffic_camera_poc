# Residential Traffic Monitoring PoC

## 概要

横浜市神奈川区・三ツ沢第25号線周辺における、坂道×通学路×住宅街の交通監視システムのProof of Concept。

車・バイク・自転車の速度と交通量を非接触で計測し、警察や行政に提出可能なレポートを自動生成する。

## プロジェクト目的

### 1. 速度超過の実態把握
- 坂道で加速する車両の速度分布可視化
- タクシー・他県ナンバー車両の通行実態
- 制限速度超過車両の割合測定

### 2. 危険挙動の検知
- 高速で下る自転車・バイクの速度測定
- 車両通行量のピーク時間帯特定
- 通学時間帯の交通状況分析

### 3. 対外提出用レポート自動生成
- 神奈川警察署・区役所への提出資料作成
- Zone30、速度抑制策検討の根拠データ提供
- PDF形式での定型レポート出力

### 4. 全国展開可能なOSS化
- 類似問題を抱える地域で再利用可能
- GitHubでの公開・配布

## 対象地域

### ロケーション
横浜市神奈川区・三ツ沢エリアの坂道（三ツ沢第25号線周辺）

### 道路特性
- **分類**: 生活道路 + 通学路 + 横浜駅への抜け道
- **実態**: 住宅街でありながら通過交通が多い

### 交通事情
- 制限速度を超過する車両が頻繁に通過
- 坂道のため自転車が高速で下ってくる
- タクシー・他県ナンバー車両が多い（ナビゲーション誘導）
- 路線バスも通行

### 設置環境
- **視点**: 自宅敷地から道路を俯瞰（高さ3-4m）
- **電源**: AC電源あり
- **通信**: WiFi接続可能
- **耐候性**: 雨除けすればノートPCも屋外設置可
- **カメラ**: 購入予定（TP-Link Tapo C320WS）

## システム要件

### 機能要件

#### 1. オブジェクト検知 ✅ 実装済み
- **使用モデル**: YOLOv8n（軽量版）
- **検知対象**:
  - 車（普通車・タクシー・軽自動車）
  - バイク
  - 自転車
  - 歩行者
- **詳細分類**: VehicleClassifier による車種詳細分類（タクシー、軽自動車、商用車等）
- **日本語表示対応**: PIL/Pillow による日本語フォントレンダリング

#### 2. 車両トラッキング ✅ 実装済み
- **アルゴリズム**: IoU-based Object Tracker（SORT/ByteTrack互換）
- **パラメータ**:
  - max_age: 30フレーム（ロスト判定）
  - min_hits: 1フレーム（即座にトラッキング開始）
  - iou_threshold: 0.3（重なり判定）
- **目的**: 同一車両をフレーム間で追跡し速度を算出

#### 3. 速度推定 ✅ 実装済み
- **方式**: 2点間距離 × 移動フレーム数による算出
- **キャリブレーション機能**:
  - Webダッシュボード上で2点クリックによる簡易キャリブレーション
  - pixels_per_meter 自動計算
  - 現在の設定: 142.33 px/m、13.00m監視範囲
- **前提条件**:
  - カメラ画角固定
  - 道路に対して視点が一定（推奨：水平視点）
  - 15-20mの監視範囲推奨（50-60km/h測定のため）
  - 単眼カメラで実装可能
- **パラメータ**:
  - FPS: 20
  - min_track_length: 7フレーム（0.35秒）
  - speed_limit: 30 km/h

- **出力データ**:
  - 時刻（JST）
  - track_id（トラッキングID）
  - 種別（car / motorcycle / bicycle / person）
  - 車両サブタイプ（taxi / kei_car / commercial等）
  - 推定速度（km/h）
  - 移動方向（上り / 下り）
  - 信頼度
  - 走行距離（meters）
  - 走行時間（seconds）
  - 軌跡長（フレーム数）

#### 4. 交通量計測 ✅ 実装済み
- SQLiteデータベースによるリアルタイム集計
- 1日・時間帯別の交通量集計（hourly_stats テーブル）
- 日次統計（daily_stats テーブル）
- 平日・休日比較
- 通学時間帯のピーク特定
- CSV形式での日次エクスポート

#### 5. レポート自動生成（PDF） 🚧 未実装
- 警察向けテンプレート
- 行政向け参照資料
- 図表（速度ヒストグラム・時系列グラフ）
- 主要指標（速度超過率、危険挙動数）

#### 6. ダッシュボード ✅ 実装済み
- **技術スタック**: FastAPI + Jinja2 Templates + Chart.js
- **URL**: http://localhost:8000
- **機能**:
  - リアルタイムカメラストリーム（MJPEG）
  - YOLO検知結果のリアルタイム表示
  - トラッキング結果の可視化
  - 速度測定結果の表示
  - 統計ダッシュボード:
    - 速度分布ヒストグラム
    - 時間帯別通行量グラフ
    - 日別通行量推移
    - 車種別内訳（円グラフ）
  - キャリブレーション設定画面（/settings）
  - 日付範囲フィルタ機能
- **データ収集**: enable_data_collection パラメータで制御可能

## 技術仕様

### ハードウェア

#### PC
- **ベース**: 既存Windowsノート → Ubuntu化
- **GPU**: 不要（軽量版YOLOを使用）
- **設置場所**: 屋外（雨除けあり）

#### カメラ

**推奨機種**: TP-Link Tapo C320WS

| 項目 | 仕様 |
|------|------|
| 解像度 | 2K QHD |
| 夜間性能 | カラーナイトビジョン |
| 電源 | 有線（AC） |
| 価格 | 約7,000-8,000円 |
| PoE対応 | × |

**選定理由**: 安定・安価・画質十分、PoC向け最適

**比較検討**: C320WS vs C510W

| 項目 | C320WS | C510W（ソーラー対応） |
|------|--------|---------------------|
| 解像度 | 2K | 2K |
| 夜間性能 | カラーナイト | カラー |
| 稼働方式 | AC電源 | AC または ソーラー+バッテリ |
| 屋外安定性 | ◎ | ◎（天候依存） |
| 価格 | 安い | やや高い |
| 長時間録画 | ◎ | △（バッテリー依存） |

**結論**: 安定性重視でC320WS採用（電源が確保できるため）

### ソフトウェア構成

```
/traffic_camera/
├── capture/
│   ├── __init__.py
│   └── stream.py              # RTSPカメラストリーム取得（OpenCV）
├── detection/
│   ├── __init__.py
│   ├── detector.py            # YOLOv8n 検知エンジン
│   └── classifier.py          # 車両詳細分類（VehicleClassifier）
├── tracking/
│   ├── __init__.py
│   └── tracker.py             # IoU-based Object Tracker
├── speed_estimation/
│   ├── __init__.py
│   └── estimator.py           # 速度推定エンジン
├── storage/
│   ├── __init__.py
│   └── database.py            # SQLite + CSV ストレージ管理
├── report/
│   ├── __init__.py
│   └── generator.py           # PDF レポート生成（未実装）
├── dashboard/
│   ├── __init__.py
│   ├── app.py                 # FastAPI メインアプリケーション
│   ├── templates/
│   │   ├── index.html         # メインダッシュボード
│   │   └── settings.html      # キャリブレーション設定画面
│   └── static/                # CSS/JS（将来拡張用）
├── data/
│   ├── traffic.db             # SQLite データベース
│   └── csv/                   # 日次CSV出力
├── logs/
│   └── traffic_monitor.log    # アプリケーションログ
├── docs/
│   ├── SETUP.md               # セットアップガイド
│   ├── SPEED_MEASUREMENT.md   # 速度測定ガイドライン
│   └── CAMERA_SETUP.md        # カメラ設置ガイド
├── config.yaml                # システム設定ファイル
├── calibration.json           # キャリブレーションデータ
├── test_camera.py             # カメラ接続テスト
├── test_detection.py          # 検知テスト
├── requirements.txt           # Python依存パッケージ
└── README.md                  # プロジェクト README
```

**主要な技術スタック:**
- **検知**: ultralytics YOLOv8n
- **トラッキング**: カスタム IoU-based tracker
- **Web**: FastAPI + Jinja2 + Chart.js
- **画像処理**: OpenCV (cv2) + PIL/Pillow
- **データベース**: SQLite3
- **データ分析**: pandas
- **カメラ**: RTSP streaming via OpenCV
- **フォント**: Hiragino/NotoSans (日本語対応)

### アルゴリズム

#### オブジェクト検知
- **モデル**: YOLOv8n or YOLOv8s（軽量版、GPU不要）
- **推論**: リアルタイム（フレーム単位）

#### トラッキング
- **手法**: ByteTrack or SORT
- **目的**: 同一車両のID保持、速度算出のための連続追跡

#### 速度推定
- **キャリブレーション**: 画像上の2点間の実距離をGoogle Mapsで測定
- **計算式**: `速度 = (距離 / フレーム数) × FPS × 3.6` (km/h)

## データ出力仕様

### CSV形式
```csv
timestamp,object_type,speed_kmh,direction,confidence
2024-01-15 08:15:32,car,45.2,downhill,0.92
2024-01-15 08:16:10,bicycle,28.5,downhill,0.87
```

### データベース（SQLite）
- 日次集計用
- レポート生成時のクエリ最適化

## レポート仕様

### 警察向けテンプレート

```
横浜市神奈川警察署 交通課 御中

件名：三ツ沢第25号線における速度超過及び危険走行に関する調査報告書

1. 調査概要
   調査期間：YYYY/MM/DD – YYYY/MM/DD
   調査地点：横浜市神奈川区（住所略）
   方式：AIカメラによる自動速度推定

2. 主な結果
   - 平均速度：XX km/h
   - 30km/h超過車両：XX%
   - 最大速度：XX km/h
   - 自転車の高速走行：XX件
   - 時間帯別ピーク：通学時間帯 XX:XX–XX:XX

3. 図表
   - 速度ヒストグラム
   - 速度超過割合
   - 時間帯別通行量

4. 要望
   - Zone30 の再点検
   - 速度抑制策の検討
   - パトロール強化の検討

5. 付録
   - 計測方法
   - AI推定の誤差範囲
   - キャプチャ画像（必要に応じて）
```

### PDF生成
- **ライブラリ**: reportlab
- **グラフ**: matplotlib
- **自動化**: 週次/月次で自動生成

## 実装状況サマリー（2025-11-15）

### 完了した機能 ✅
- [x] オブジェクト検知（YOLOv8n）
- [x] 車両トラッキング（IoU-based）
- [x] 速度推定エンジン
- [x] Webダッシュボード（FastAPI）
- [x] リアルタイムカメラストリーム
- [x] データ収集・保存（SQLite + CSV）
- [x] 統計グラフ表示（Chart.js）
- [x] キャリブレーション機能
- [x] 車両詳細分類（VehicleClassifier）
- [x] 日本語フォント対応（PIL）

### 未実装の機能 🚧
- [ ] PDF レポート自動生成
- [ ] 自転車逆走検知
- [ ] 危険挙動検知（はみ出し、幅寄せ）
- [ ] 自動週次/月次レポート
- [ ] クラウド同期機能

## 今後の拡張案

### フェーズ2: 詳細分析
- 車種分類（軽自動車・普通車・タクシー・バス）✅ 実装済み
- 自転車の逆走検知 🚧 未実装
- 危険挙動（はみ出し、幅寄せ）の検知 🚧 未実装

### フェーズ3: データ連携
- クラウド同期（AWS S3 / Cloudflare R2）
- 複数地点の統合分析
- ダッシュボードのクラウド化

### フェーズ4: OSS化
- ドキュメント整備
- 汎用化（他地域でも使えるように）
- GitHub公開・メンテナンス
- 全国自治体への配布

## 既知の問題

### カメラストリーム安定性
- **問題**: RTSPストリームが30秒タイムアウトでクラッシュすることがある
- **原因**: カメラ側の一時的な接続問題、ネットワーク不安定
- **対策**:
  - タイムアウト値の調整
  - 自動再接続機能の実装
  - カメラ設定の見直し（ストリーム品質）

## ライセンス

MIT License（予定）

## 関連リンク

- GitHub Repository: https://github.com/monobe/traffic_camera_poc
- YOLOv8: https://github.com/ultralytics/ultralytics
- ByteTrack: https://github.com/ifzhang/ByteTrack
